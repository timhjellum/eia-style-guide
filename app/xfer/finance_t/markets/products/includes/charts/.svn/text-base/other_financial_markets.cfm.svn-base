<style>
		#efmi_ofm {
			width:100%;
		}
		#efmi_ofm .qtr {
			width: 25%;
			height:100%;
		}
		#legend {
			margin-top:	2.5em;
			padding: 0;
			text-align: center;
		}
		#efmi_ofm span,
		#legend span{
			font-weight: bold;
			display: inline-block;
		}
		#legend .vals {
			height: 20px;
	    width: 85px;
		}
		
		#legend div span{
			width: 50%;
			text-align: center;
		}
		#efmi_ofm tr td {
			border-bottom: 1px solid gray;
			border-right: 1px solid gray;
			height: 40px;
			padding: 0;
		}
		
		#efmi_ofm tr th{
			border-bottom: none;
			text-align: center;
		}
		
		#efmi_ofm td.first_col {
			background-color: white;
			border-left: 1px solid gray;
			text-align: center;
			padding: 0 5px;
			vertical-align: bottom;
		}
		
		.negative.low {
			background-color: #4cc9ff;
		}
		.negative.med {
			background-color: #0196d8;
		}
		.negative.high{
			background-color: #00628c;
		}
		
		.positive.low {
			background-color: #91c767;
		}
		.positive.med {
			background-color: #5d9731;
		}
		.positive.high{
			background-color: #32630c;
		}
		.empty {
			background-color: white;
		}
		.noVal {
			background-color: lightgray;
		}
		#efmi_ofm span.oilPeak {
			border-left: 2px solid black;
			margin-right: -2px;
		}
	 .peakLbl{
			position: absolute;
		}
	</style>
  
	<script type="text/javascript">
		$(function(){
			var label = $('.peakLbl'),
					offset = $('.oilPeak').offset(),
					width = label.width();
					
			label.css( 'left',offset.left - (width/2) );
		});
	</script>
  
  <cfquery name="query" datasource="energystatsweb" cachedwithin="#CreateTimeSpan(0,1,0,0)#">
    SELECT substr(yyyyqq_datex,4,4) as year, substr(yyyyqq_datex,0,1) as qtr, s_and_p as snp,  dxy, treasury
    FROM energystats.efmi_other_financial_markets
  </cfquery>

	<cfset snpArr = structNew() >
	<cfset dxyArr = structNew() >
	<cfset bondsArr = structNew() >

  <cfloop query="query" >
    <cfset snpArr[#year#][#qtr#] = #snp#  >
    <cfset dxyArr[#year#][#qtr#] = #dxy# >
    <cfset bondsArr[#year#][#qtr#] = #treasury# >
  </cfloop>
  
  <cfscript>
		function getClassForValue( value ){
			
			if( value EQ 'noVal' )
				return 'noVal';
			
			if( value LT -0.26 )
				class = "negative";
			else if( value GT 0.26 )
				class = "positive";
			else
				class = "empty";
				

			value = Abs(value);
			
			if ( value GT 0.26 AND value LT 0.4 )
				class = class & " low";
				
			else if ( value GT 0.40 AND value LT 0.65 )
				class = class & " med";
				
			else if ( value GT 0.65 )
				class = class & " high";
				
			else
				class = class & " empty";

			return class;
		}
		
		function isArrayElementDefined(arrayName){
			//use try{} to attempt using the array element
			try{
				//use the array element and return true
				testVar = evaluate(arrayName);
				return true;
			//if using it causes an error catch it and return false
			}catch(any test){
				return false;
        }
    }
		
		keyArr = StructKeyArray(snpArr);
		ArraySort(keyArr,'text','asc' );
		
		header = '';
		snpRow = '<td class="first_col">S &amp; P 500</td>';
		dxyRow = '<td class="first_col">U.S. Dollar*</td>';
		bondsRow = '<td class="first_col">U.S. Bonds**</td>';
	</cfscript>

<div style=" margin-bottom: -5px; font-size:16px; font-weight:bold;">Correlations (+ or -) between daily returns on crude oil and financial investments</div>
   <!-- <h2>Correlations (+ or -) between daily returns on crude oil<br>and financial investments have also strengthened</h2> --> 
	<div>
  	<table id="efmi_ofm" style="color:white;">
    
    	<cfoutput>
				
        <cfloop from="1" to="#arrayLen(keyArr)#" index="i" >
          <cfset header = header & "<th>#keyArr[i]#</th>" >
          <!---cfdump var="#snpArr[ keyArr[i] ]#"--->
          
          <cfscript>
						keyQtrArr = StructKeyArray(snpArr[ keyArr[i] ]);
						ArraySort(keyQtrArr,'text','asc' );
						snp = '';
						bonds = '';
						dxy = '';
					</cfscript>

					<!--- loop through the quarters --->
          <cfloop from="1" to="4" index="e" >
          	<cfif isArrayElementDefined("keyQtrArr[#e#]")>
	          	<cfset snpVal = #snpArr[ keyArr[i] ][keyQtrArr[e]]# >
            <cfelse>
            	<cfset snpVal = 'noVal' >
            </cfif>
            
            <cfif isArrayElementDefined("keyQtrArr[#e#]")>
	          	<cfset dxyVal = #dxyArr[ keyArr[i] ][keyQtrArr[e]]# >
            <cfelse>
            	<cfset dxyVal = 'noVal' >
            </cfif>
            
            <cfif isArrayElementDefined("keyQtrArr[#e#]")>
	          	<cfset bondsVal = #bondsArr[ keyArr[i] ][keyQtrArr[e]]# >
            <cfelse>
            	<cfset bondsVal = 'noVal' >
            </cfif>
						
            <cfif keyArr[i] EQ '2008' AND keyQtrArr[e] EQ '03'>
							<cfset border = "oilPeak"> <!--- use class rightBorder but if shifts the whole span, not good--->
            <cfelse>
              <cfset border = "">
            </cfif>
            
          	<cfset snp = snp & "<span class=""qtr #getClassForValue( snpVal )# #border#"" alt=""Quarter #e#""></span>" > <!---  --->
            <cfset dxy = dxy & "<span class=""qtr #getClassForValue( dxyVal )# #border#"" alt=""Quarter #e#""></span>" >
            <cfset bonds = bonds & "<span class=""qtr #getClassForValue( bondsVal)# #border#"" alt=""Quarter #e#""></span>" >
           
          </cfloop>
          
          <cfset snpRow = snpRow & "<td>#snp#</td>">
          <cfset dxyRow = dxyRow & "<td>#dxy#</td>">
          <cfset bondsRow = bondsRow & "<td>#bonds#</td>">

        </cfloop>
     	<tr>
      	<th></th> <!--- empty first header cell --->
        #header#
      </tr>
      <tr>
        #snpRow#
      </tr>
      <tr>
        #dxyRow#
      </tr>
      <tr>
        #bondsRow#
      </tr>
      </cfoutput>
    </table>
  </div>
  <span class="peakLbl">WTI crude oil price peak</span>
  <div id="legend">    
    <span class="vals negative high">< -0.65</span><span class="vals negative med">-0.65 to -0.4</span><span class="vals negative low">-0.4 to -0.25</span><span class="vals empty">-0.25 to 0.25</span><span class="vals positive low">0.25 to 0.4</span><span class="vals positive med">0.4 to 0.65</span><span class="vals positive high">> 0.65</span>
    <div><span>Negative Correlation</span><span>Positive Correlation</span></div>
  </div>
  <p><span style="color:gray;font-size:10px;">Source: <a href="http://www.eia.gov/">U.S. Energy Information Administration</a></span><br>
  	 <span style="color:grey;font-size:10px;">Updated: quarterly | Last Updated: April 14, 2011</span></p>
  <p>* U.S. Dollar Index (DXY), which is a weighted index of a basket of currencies, per U.S. dollar. As the dollar strengthens against other currencies, the value of the index rises.</p>
  <p>** U.S. bonds is based on the negative of the change in yield on 30-year U.S. government bonds because as yields rise, bond prices fall.</p>